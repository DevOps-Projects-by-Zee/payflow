# ============================================
# Azure Key Vault External Secrets Configuration
# ============================================
# Purpose: Sync secrets from Azure Key Vault into Kubernetes Secrets
# Usage: kubectl apply -f k8s/external-secrets/azure-keyvault-secrets.yaml
#
# HOW IT WORKS:
# 1. SecretStore defines Azure Key Vault as source (uses Workload Identity)
# 2. ExternalSecret references SecretStore and maps Azure secret names to K8s secret keys
# 3. ESO syncs automatically and keeps Kubernetes Secret updated
# 4. Pods use Kubernetes Secret normally via secretKeyRef
#
# HYBRID CLOUD: This works alongside AWS Secrets Manager
# - Secrets from AWS → External Secrets → db-secrets (Merge policy)
# - Secrets from Azure → External Secrets → db-secrets (Merge policy)
# - Same Kubernetes Secret populated from both sources
#
# NOTE: Replace placeholder values with actual values from Terraform output:
#   terraform output key_vault_url
#   terraform output workload_identity_managed_identity_client_id

# ============================================
# SecretStore: Azure Key Vault (Workload Identity)
# ============================================
# SecretStore tells ESO where to fetch secrets from Azure Key Vault
# Uses Workload Identity: No client secrets needed - uses federated identity
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-key-vault
  namespace: payflow
spec:
  provider:
    azurekv:
      # Azure Key Vault URL (from Terraform output: key_vault_url)
      # Format: https://<vault-name>.vault.azure.net
      # Get from: terraform output key_vault_url
      vaultUrl: "https://payflow-secrets.vault.azure.net"  # REPLACE: Get from terraform output key_vault_url
      
      # Authentication: Use Workload Identity (recommended for AKS)
      # This uses the federated identity credential created by workload-identity module
      authType: WorkloadIdentity
      
      # Service Account with Workload Identity annotation
      # This service account must have the azure.workload.identity/client-id annotation
      serviceAccountRef:
        name: payflow-sa  # Service account created by workload-identity module
        namespace: payflow
      
      # Alternative: Service Principal (if Workload Identity not available)
      # authType: ServicePrincipal
      # tenantId: "REPLACE_WITH_AZURE_TENANT_ID"
      # authSecretRef:
      #   clientId:
      #     name: azure-credentials
      #     key: clientId
      #   clientSecret:
      #     name: azure-credentials
      #     key: clientSecret
---
# ============================================
# ExternalSecret: PostgreSQL Credentials (Azure Key Vault)
# ============================================
# Syncs PostgreSQL password from Azure Key Vault
# Azure Key Vault secret name: payflow-database-password
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-postgres-credentials
  namespace: payflow
spec:
  refreshInterval: 1h  # Sync every hour
  secretStoreRef:
    name: azure-key-vault
    kind: SecretStore
  target:
    name: db-secrets  # Kubernetes Secret name (same as AWS secrets)
    creationPolicy: Merge  # Merge with existing secret (combines AWS + Azure secrets)
  data:
    # Azure Key Vault stores secrets as plain strings, not JSON
    # So we map the secret name directly to the K8s secret key
    - secretKey: DB_PASSWORD
      remoteRef:
        key: payflow-database-password  # Secret name in Azure Key Vault
    # DB_USER is stored separately or can be hardcoded in ConfigMap
    - secretKey: DB_USER
      remoteRef:
        key: payflow-database-username  # If stored in Key Vault, or use default
        # If not in Key Vault, DB_USER defaults from db-secrets.yaml
---
# ============================================
# ExternalSecret: Redis Password (Azure Key Vault)
# ============================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-redis-password
  namespace: payflow
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: SecretStore
  target:
    name: db-secrets
    creationPolicy: Merge
  data:
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: payflow-redis-password  # Secret name in Azure Key Vault
---
# ============================================
# ExternalSecret: API Key (Azure Key Vault)
# ============================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-api-key
  namespace: payflow
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: SecretStore
  target:
    name: db-secrets
    creationPolicy: Merge
  data:
    - secretKey: API_KEY
      remoteRef:
        key: payflow-api-key  # Secret name in Azure Key Vault
---
# ============================================
# ExternalSecret: Service Bus Connection Strings (Azure Key Vault)
# ============================================
# Syncs Service Bus connection strings from Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-servicebus-credentials
  namespace: payflow
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: SecretStore
  target:
    name: db-secrets
    creationPolicy: Merge
  data:
    # Service Bus transactions queue connection string
    - secretKey: SERVICE_BUS_TRANSACTIONS_CONNECTION
      remoteRef:
        key: payflow-servicebus-transactions-connection
    # Service Bus notifications queue connection string
    - secretKey: SERVICE_BUS_NOTIFICATIONS_CONNECTION
      remoteRef:
        key: payflow-servicebus-notifications-connection
    # Service Bus namespace name
    - secretKey: SERVICE_BUS_NAMESPACE
      remoteRef:
        key: payflow-servicebus-namespace
---
# ============================================
# Service Account: Azure Workload Identity
# ============================================
# Purpose: Service account with Workload Identity annotation for Azure Key Vault access
# This service account is used by External Secrets Operator to authenticate to Azure Key Vault
# The annotation links to the managed identity created by workload-identity module
apiVersion: v1
kind: ServiceAccount
metadata:
  name: payflow-sa
  namespace: payflow
  annotations:
    # Azure Workload Identity annotation
    # Links this service account to Azure Managed Identity
    # Format: azure.workload.identity/client-id: <managed-identity-client-id>
    # Get client ID from: terraform output workload_identity_managed_identity_client_id
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"  # From terraform output
---
# ============================================
# NOTES: Hybrid Cloud Secret Management
# ============================================
# You can have BOTH AWS and Azure secrets syncing to the same Kubernetes Secret:
#
# 1. AWS Secrets Manager → External Secrets → db-secrets (via aws-secrets-manager SecretStore)
# 2. Azure Key Vault → External Secrets → db-secrets (via azure-key-vault SecretStore)
#
# Both use Merge policy, so they combine into the same 'db-secrets' Kubernetes Secret
#
# Example secret keys in db-secrets:
# - DB_USER (from AWS or Azure)
# - DB_PASSWORD (from Azure Key Vault)
# - REDIS_PASSWORD (from Azure Key Vault)
# - JWT_SECRET (from AWS Secrets Manager)
# - RABBITMQ_USER (from AWS Secrets Manager - will be replaced by Service Bus)
# - SERVICE_BUS_TRANSACTIONS_CONNECTION (from Azure Key Vault)
#
# This allows:
# - Gradual migration from AWS to Azure
# - Different secrets in different clouds (compliance)
# - Disaster recovery scenarios
# - No single point of failure

