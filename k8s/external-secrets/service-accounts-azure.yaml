# ============================================
# Service Accounts with Azure Workload Identity Annotations
# ============================================
# Purpose: Service accounts that allow pods to access Azure Key Vault via Workload Identity
# Usage: kubectl apply -f k8s/external-secrets/service-accounts-azure.yaml
#
# HOW AZURE WORKLOAD IDENTITY WORKS:
# 1. Azure Managed Identity created by workload-identity module
# 2. Federated identity credential links K8s service account to Azure identity
# 3. Pod using this service account gets Azure token automatically
# 4. Pod can call Azure APIs (Key Vault) without storing keys
#
# NOTE: Replace REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID with actual client ID:
#   terraform output workload_identity_primary_client_id
#
# HYBRID CLOUD: You can use BOTH AWS IRSA and Azure Workload Identity
# - Service accounts can have both annotations
# - Pods can access both AWS Secrets Manager and Azure Key Vault
# - Use different service accounts if you want to separate concerns

apiVersion: v1
kind: ServiceAccount
metadata:
  name: auth-service-azure
  namespace: payflow
  annotations:
    # Azure Workload Identity annotation: Links service account to Azure Managed Identity
    # This allows pods using this service account to access Azure Key Vault
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"  # From terraform output
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wallet-service-azure
  namespace: payflow
  annotations:
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: transaction-service-azure
  namespace: payflow
  annotations:
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: notification-service-azure
  namespace: payflow
  annotations:
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway-azure
  namespace: payflow
  annotations:
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: db-migration-job-azure
  namespace: payflow
  annotations:
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: transaction-timeout-handler-azure
  namespace: payflow
  annotations:
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"
---
# ============================================
# ALTERNATIVE: Update Existing Service Accounts
# ============================================
# If you prefer to use the same service accounts for both AWS and Azure,
# you can add both annotations to the existing service-accounts.yaml:
#
# annotations:
#   eks.amazonaws.com/role-arn: "arn:aws:iam::..."
#   azure.workload.identity/client-id: "..."
#
# This allows pods to access both AWS Secrets Manager AND Azure Key Vault
# from the same service account (hybrid cloud support)

