# ============================================
# Service Accounts with IRSA Annotations
# ============================================
# Purpose: Service accounts that allow pods to assume AWS IAM role via IRSA
# Usage: kubectl apply -f k8s/external-secrets/service-accounts.yaml
#
# HOW IRSA WORKS:
# 1. EKS OIDC provider trusts AWS IAM role
# 2. Service account annotation links to IAM role ARN
# 3. Pod using this service account gets temporary AWS credentials
# 4. Pod can call AWS APIs (Secrets Manager) without storing keys
#
# NOTE: Replace REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN with actual role ARN:
#   terraform output -raw secrets_access_role_arn

apiVersion: v1
kind: ServiceAccount
metadata:
  name: auth-service
  namespace: payflow
  annotations:
    # IRSA annotation: Links service account to IAM role for Secrets Manager access
    # This allows pods using this service account to access AWS Secrets Manager
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wallet-service
  namespace: payflow
  annotations:
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: transaction-service
  namespace: payflow
  annotations:
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: notification-service
  namespace: payflow
  annotations:
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: payflow
  annotations:
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: db-migration-job
  namespace: payflow
  annotations:
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: transaction-timeout-handler
  namespace: payflow
  annotations:
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres
  namespace: payflow
  annotations:
    eks.amazonaws.com/role-arn: "REPLACE_WITH_SECRETS_ACCESS_ROLE_ARN"

