# ============================================
# Network Policies for PayFlow
# ============================================
# Purpose: Implement network segmentation and security controls
# Controls traffic flow between pods based on labels and namespaces

# ============================================
# Default Deny All Traffic
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: payflow
spec:
  podSelector: {}  # Match all pods
  policyTypes:
  - Ingress
  - Egress
  # No rules = deny all traffic
---
# ============================================
# Allow API Gateway to Receive External Traffic
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-allow-ingress
  namespace: payflow
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Ingress
  ingress:
  - from: []  # Allow from anywhere (ingress controller, load balancer)
    ports:
    - protocol: TCP
      port: 3000
---
# ============================================
# Allow Frontend to Receive External Traffic
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-allow-ingress
  namespace: payflow
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  ingress:
  - from: []  # Allow from anywhere (ingress controller, load balancer)
    ports:
    - protocol: TCP
      port: 80
---
# ============================================
# Allow API Gateway to Connect to Backend Services
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-allow-egress
  namespace: payflow
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Egress
  egress:
  # Allow API Gateway to connect to backend services
  - to:
    - podSelector:
        matchLabels:
          app: auth-service
    ports:
    - protocol: TCP
      port: 3004
  - to:
    - podSelector:
        matchLabels:
          app: wallet-service
    ports:
    - protocol: TCP
      port: 3001
  - to:
    - podSelector:
        matchLabels:
          app: transaction-service
    ports:
    - protocol: TCP
      port: 3002
  - to:
    - podSelector:
        matchLabels:
          app: notification-service
    ports:
    - protocol: TCP
      port: 3003
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS for external API calls (if needed)
  - to: []
    ports:
    - protocol: TCP
      port: 443
---
# ============================================
# Allow Backend Services to Connect to Database
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: services-allow-db
  namespace: payflow
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - auth-service
      - wallet-service
      - transaction-service
      - notification-service
  policyTypes:
  - Egress
  egress:
  # Allow connection to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Allow connection to Redis
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow connection to RabbitMQ
  - to:
    - podSelector:
        matchLabels:
          app: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
---
# ============================================
# Allow Transaction Service to Connect to Wallet Service
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: transaction-service-allow-wallet
  namespace: payflow
spec:
  podSelector:
    matchLabels:
      app: transaction-service
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: wallet-service
    ports:
    - protocol: TCP
      port: 3001
  # Allow connection to RabbitMQ
  - to:
    - podSelector:
        matchLabels:
          app: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53

