# ============================================
# Kustomize Configuration for PayFlow
# ============================================
# Purpose: Manifest bundling for ArgoCD GitOps
# Usage: kubectl apply -k k8s/
# Or let ArgoCD sync this automatically

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# NOTE: No default namespace set
# Each resource specifies its own namespace explicitly
# This prevents conflicts with monitoring and argocd namespaces

resources:
  # Namespaces
  - namespace.yaml
  - monitoring-namespace.yaml
  - argocd-namespace.yaml
  
  # ArgoCD Configuration
  - argocd/argocd-configmap.yaml
  - argocd/argocd-certificate-issuer.yaml
  
  # Secrets and ConfigMaps
  - secrets/db-secrets.yaml
  # Cloudflare tunnel secret (contains sensitive token - not in kustomization by default)
  # Apply manually: kubectl apply -f secrets/cloudflare-tunnel-secret.yaml
  - configmaps/app-config.yaml
  
  # External Secrets Operator (Hybrid Cloud: AWS + Azure)
  # Install ESO first: kubectl apply -f external-secrets/eso-install.yaml
  # Then apply service accounts and external secrets
  - external-secrets/service-accounts.yaml  # AWS IRSA service accounts
  - external-secrets/service-accounts-azure.yaml  # Azure Workload Identity service accounts
  - external-secrets/external-secrets.yaml  # AWS Secrets Manager
  - external-secrets/azure-keyvault-secrets.yaml  # Azure Key Vault
  # NOTE: Remember to replace placeholder ARNs/URLs with actual values from Terraform outputs
  # Use script: ./scripts/local/update-azure-secrets-config.sh
  
  # Infrastructure
  - statefulsets/postgres.yaml
  - deployments/rabbitmq.yaml
  - deployments/redis.yaml
  
  # Application Services
  - deployments/api-gateway.yaml
  - deployments/auth-service.yaml
  - deployments/wallet-service.yaml
  - deployments/transaction-service.yaml
  - deployments/notification-service.yaml
  - deployments/frontend.yaml
  - deployments/cloudflare-tunnel.yaml
  
  # Jobs
  - jobs/db-migration.yaml
  - jobs/transaction-timeout.yaml
  
  # Ingress
  - ingress/tls-ingress.yaml
  - ingress/monitoring-ingress.yaml
  - ingress/argocd-ingress.yaml
  
  # Production Policies
  - policies/pod-disruption-budgets.yaml
  - policies/resource-quotas.yaml
  # Network policies disabled by default (can be enabled when needed)
  # - policies/network-policies.yaml
  
  # Autoscaling
  - autoscaling/hpa-config.yaml
  
  # Backups
  - backups/postgres-backup-cronjob.yaml
  
  # Security
  - security/image-scanning-cronjob.yaml
  
  # Monitoring
  - monitoring/prometheus-config.yaml
  - monitoring/prometheus-deployment.yaml
  - monitoring/alertmanager-deployment.yaml
  - monitoring/loki-deployment.yaml
  - monitoring/promtail-deployment.yaml
  # NOTE: Grafana deployment removed - using Azure Managed Grafana instead
  # Grafana datasources kept for reference (Azure Managed Grafana will use Azure Monitor/Prometheus)
  # - monitoring/grafana-datasources.yml
  # - monitoring/grafana-dashboards.yaml
  # - monitoring/grafana-deployment.yaml

