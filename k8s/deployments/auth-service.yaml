# #### PayFlow Auth Service ####
# #### This Service exposes the authentication service internally ####
apiVersion: v1  # #### Kubernetes API version ####
kind: Service  # #### Resource type - exposes pods to network traffic ####
metadata:
  name: auth-service  # #### Service name ####
  namespace: payflow  # #### Namespace ####
spec:
  ports:
    - port: 3004  # #### Service port ####
  selector:
    app: auth-service  # #### Select pods with this label ####

---
# #### PayFlow Auth Service Deployment ####
# #### This Deployment manages the authentication service pods ####
apiVersion: apps/v1  # #### Kubernetes API version ####
kind: Deployment  # #### Resource type - manages pod replicas ####
metadata:
  name: auth-service  # #### Deployment name ####
  namespace: payflow  # #### Namespace ####
spec:
  replicas: 2  # #### Number of pod replicas for high availability ####
  selector:
    matchLabels:
      app: auth-service  # #### Select pods with this label ####
  template:
    metadata:
      labels:
        app: auth-service  # #### Pod label ####
    spec:
      containers:
      - name: auth-service
        image: payflow/auth-service:latest  # #### Docker image ####
        imagePullPolicy: Never  # #### Use local image, don't pull from registry ####
        ports:
        - containerPort: 3004  # #### Container port ####
        env:
        # #### Database Configuration ####
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:  # #### Get value from ConfigMap ####
              name: app-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DB_PORT
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DB_NAME
        - name: DB_USER
          valueFrom:
            secretKeyRef:  # #### Get value from Secret ####
              name: db-secrets
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:  # #### Get password from Secret ####
              name: db-secrets
              key: DB_PASSWORD
        # #### Cache Configuration ####
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: REDIS_URL
        # #### Security Configuration ####
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:  # #### Get JWT secret from Secret ####
              name: db-secrets
              key: JWT_SECRET
        resources:
          requests:  # #### Minimum resources required ####
            memory: "256Mi"  # #### Minimum memory ####
            cpu: "250m"      # #### Minimum CPU ####
          limits:  # #### Maximum resources allowed ####
            memory: "512Mi"  # #### Maximum memory ####
            cpu: "500m"      # #### Maximum CPU ####
        # #### Health Checks ####
        livenessProbe:  # #### Check if container is alive ####
          httpGet:
            path: /health  # #### Health check endpoint ####
            port: 3004     # #### Health check port ####
          initialDelaySeconds: 30  # #### Wait 30s before first check ####
          periodSeconds: 10       # #### Check every 10 seconds ####
        readinessProbe:  # #### Check if container is ready to serve traffic ####
          httpGet:
            path: /health  # #### Health check endpoint ####
            port: 3004     # #### Health check port ####
          initialDelaySeconds: 5  # #### Wait 5s before first check ####
          periodSeconds: 5       # #### Check every 5 seconds ####
